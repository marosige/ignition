#!/bin/bash

# Check for dependencies
if ! command -v yt-dlp &> /dev/null; then
    echo "Error: yt-dlp is not installed. Install it using 'brew install yt-dlp'."
    exit 1
fi

if ! command -v ffmpeg &> /dev/null; then
    echo "Error: ffmpeg is not installed. Install it using 'brew install ffmpeg'."
    exit 1
fi

# Usage info
usage() {
    echo
    echo "Usage:"
    echo "  youtube-mp3 <YouTube_URL>"
    echo
    echo "Downloads audio from YouTube or YouTube Music:"
    echo "  • Playlists → saved in folders under the current directory"
    echo "  • Single tracks → saved in current directory"
    echo
    exit 1
}

# Get and validate URL
YT_URL="$1"
if [[ -z "$YT_URL" ]]; then
    echo "Error: No URL provided."
    usage
fi

# Normalize URL for case-insensitive matching
YT_URL_LC="$(echo "$YT_URL" | tr '[:upper:]' '[:lower:]')"

# Detect playlist
if [[ "$YT_URL_LC" == *"playlist?list="* ]]; then
    if [[ "$YT_URL_LC" == *"music.youtube.com"* ]]; then
        # YouTube Music playlist
        yt-dlp \
            -f bestaudio \
            --extract-audio \
            --audio-format mp3 \
            --output "%(album_artist)s - %(release_year)s - %(album)s/%(playlist_index)03d - %(title)s%(feat_add)s.%(ext)s" \
            --parse-metadata "artist:%(feat_add>.artist:-%(album_artist)s)s" \
            --replace-in-metadata feat_add "^( - )?(.*)$" " (feat. \2)" \
            "$YT_URL"
    else
        # Regular YouTube playlist
        yt-dlp \
            -f bestaudio \
            --extract-audio \
            --audio-format mp3 \
            --output "%(playlist_title)s/%(playlist_index)03d - %(title)s.%(ext)s" \
            "$YT_URL"
    fi
else
    # Single video or music track
    if [[ "$YT_URL_LC" == *"music.youtube.com"* ]]; then
        yt-dlp \
            -f bestaudio \
            --extract-audio \
            --audio-format mp3 \
            --output "%(title)s%(feat_add)s.%(ext)s" \
            --parse-metadata "artist:%(feat_add>.artist:-%(album_artist)s)s" \
            --replace-in-metadata feat_add "^( - )?(.*)$" " (feat. \2)" \
            "$YT_URL"
    else
        yt-dlp \
            -f bestaudio \
            --extract-audio \
            --audio-format mp3 \
            --output "%(title)s.%(ext)s" \
            "$YT_URL"
    fi
fi

echo "✅ Download complete."